generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile  Profile?
  resumes  Resume[]
  jobs     Job[]
  skills   UserSkill[]
}

model Profile {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // JSON Resume format for master career data
  careerData Json?

  // Parsed sections for quick access
  basics     Json?  // name, email, phone, location, summary
  work       Json?  // array of work experiences
  education  Json?  // array of education entries
  projects   Json?  // array of projects
  volunteer  Json?  // array of volunteer experiences
  certifications Json?  // array of certifications

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Resume {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobId     String?
  job       Job?     @relation(fields: [jobId], references: [id], onDelete: SetNull)

  // Generated content
  content      Json      // The tailored resume content
  coverLetter  String?   // Generated cover letter
  linkedInSummary String? // Generated LinkedIn summary

  // Matching results
  matchScore   Float?
  coverageMap  Json?     // FULL/PARTIAL/GAP for each requirement

  // Provenance tracking
  provenance   Json?     // Tracks origin of each piece of content

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Job {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Original input
  rawDescription String

  // Parsed data
  title          String?
  company        String?
  seniorityLevel String?  // entry, mid, senior, lead, executive

  // Extracted requirements
  requiredSkills   Json?  // P1 skills
  preferredSkills  Json?  // P2-P4 skills
  responsibilities Json?
  requirements     Json?  // years experience, education, etc.

  resumes Resume[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Skill {
  id          String   @id @default(cuid())
  name        String   @unique
  category    String   // technical, soft, tool, domain
  aliases     String[] // alternative names for matching

  // Vector embedding for semantic matching
  embedding   Unsupported("vector(768)")?

  userSkills  UserSkill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserSkill {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  skillId     String
  skill       Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  proficiency    String?  // beginner, intermediate, advanced, expert
  yearsExperience Float?
  lastUsed       DateTime?
  source         String   // manual, parsed, inferred, github

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, skillId])
}

model Document {
  id        String   @id @default(cuid())
  userId    String

  // File info
  filename     String
  mimeType     String
  storagePath  String   // Supabase storage path

  // Parsing status
  status       String   @default("pending") // pending, processing, completed, failed
  parsedData   Json?    // Extracted content
  error        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
